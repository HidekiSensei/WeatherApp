<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <title>Weather App</title>
    <link rel="icon" href="weather-partly-cloudy.png">
</head>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const dateInputs = document.querySelectorAll('.date-input');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const historyChecker = document.getElementById('historyChecker');
        const chartTableSwitch = document.getElementById('chartTableSwitch');
        const tableContainer = document.getElementById('tableContainer');
        const chartContainer = document.getElementById('chartContainer');
        var url = "";

        const locationList = document.getElementById('locationList');
        const locationSelect = document.getElementById('location');

        if (chartTableSwitch.checked) {
            tableContainer.style.display = 'none';
            chartContainer.style.display = 'block';
        } else {
            tableContainer.style.display = 'block';
            chartContainer.style.display = 'none';
        }

        const temperatureChart = new Chart(document.getElementById("temperatureChart"), {
            type: "line",
            options: {
                scales: {
                    x: {
                        type: "time", // Änderung auf 'time'
                        position: "bottom",
                        title: {
                            display: true,
                            text: "", // Initial leeren Text setzen
                        },
                        time: {
                            unit: 'day', // Änderung auf 'day'
                            displayFormats: {
                                hour: 'HH:mm', // Anzeigeformat für Stunden
                            },
                        },
                    },
                    y: {
                        type: "linear",
                        position: "left",
                        title: {
                            display: true,
                            text: "Temperatur",
                        },
                    },
                },
                plugins: {
                    legend: {
                        display: false, // Legend ausblenden
                    },
                },
                title: {
                    text: "",
                }
            },
        });

        function formatAndRestrictInput(inputField, length) {
            inputField.addEventListener('input', function (event) {
                let inputValue = event.target.value.replace(/\D/g, '');

                if (inputValue.length > length) {
                    inputValue = inputValue.slice(0, length);
                }

                if (inputValue.length > 4) {
                    inputValue = inputValue.slice(0, 4) + '-' + inputValue.slice(4, 6) + '-' + inputValue.slice(6);
                } else if (inputValue.length > 2) {
                    inputValue = inputValue.slice(0, 2) + '-' + inputValue.slice(2, 4);
                }

                event.target.value = inputValue;
            });
        }

        formatAndRestrictInput(startDateInput, 8);
        formatAndRestrictInput(endDateInput, 8);

        function isValidDateFormat(dateString) {
            const dateRegex = /^(19[789]\d|20[012]\d)-(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])$/;
            return dateRegex.test(dateString);
        }

        function isWithin24Hours(startDate, endDate) {
            const diffInHours = Math.abs(endDate - startDate) / 36e5;
            return diffInHours <= 24;
        }

        function getCurrentDate() {
            const currentTime = new Date();
            const day = currentTime.getDate() - 1;
            const month = currentTime.getMonth() + 1;
            const year = currentTime.getFullYear();

            const formattedDay = day < 10 ? "0" + day : day;
            const formattedMonth = month < 10 ? "0" + month : month;

            const startDate = year + "-" + formattedMonth + "-" + formattedDay;
            const endDate = year + "-" + formattedMonth + "-" + formattedDay;

            return startDate
        }

        async function callToApi(url) {
            const response = await fetch(url);
            console.info("HTTP-Status: Code " + response.status + "\nURL: " + url);

            if (response.ok) {
                const body = await response.json();
                const tempArray = [];
                const timeArray = [];

                body.hourly.time.forEach((element, index) => {
                    element = element.replace('T', ' ');

                    const tempData = body.hourly.temperature_2m[index];
                    const timeData = new Date(element);

                    tempArray.push(tempData);
                    timeArray.push(timeData);
                });

                if (chartTableSwitch.checked) {
                    temperatureChart.data = {
                        labels: timeArray,
                        datasets: [{
                            label: 'Temperatur',
                            data: tempArray,
                            fill: false,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            tension: 0.1,
                        }],
                    };

                    // Wenn die Zeitspanne kleiner als einen Tag ist, füge das Datum zum Titel hinzu
                    if (isWithin24Hours(timeArray[0], timeArray[timeArray.length - 1])) {
                        temperatureChart.options.scales.x.time.unit = 'hour';
                        temperatureChart.options.title.text = `Temperatur über die Zeit - ${timeArray[0].toLocaleDateString()}`;
                    } else {
                        temperatureChart.options.scales.x.time.unit = 'day';
                        temperatureChart.options.title.text = 'Temperatur über die Zeit';
                    }

                    temperatureChart.update();
                } else {
                    const table = document.getElementById("tempTable");
                    while (table.firstChild) {
                        table.removeChild(table.firstChild);
                    }
                    tempArray.forEach((tempData, index) => {
                        const row = document.createElement('tr');
                        const dateCell = document.createElement('td');
                        const valueCell = document.createElement('td');

                        dateCell.innerHTML = new Date(timeArray[index]).toLocaleString();
                        valueCell.innerHTML = tempData;

                        row.appendChild(dateCell);
                        row.appendChild(valueCell);
                        table.appendChild(row);
                    });
                }
            }
        }

        async function fetchWeatherData() {
            const startDate = startDateInput.value ? startDateInput.value : getCurrentDate();
            const endDate = endDateInput.value ? endDateInput.value : getCurrentDate();

            if (isValidDateFormat(startDate) && isValidDateFormat(endDate)) {
                if (!historyChecker.checked) {
                    const sixMonthsAgo = new Date();
                    sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);

                    const sevenDaysInFuture = new Date();
                    sevenDaysInFuture.setDate(sevenDaysInFuture.getDate() + 7);

                    if (new Date(startDate) < sixMonthsAgo || new Date(endDate) < sixMonthsAgo || new Date(endDate) > sevenDaysInFuture) {
                        alert("Das Datum darf nicht älter als 6 Monate sein und nicht weiter als 7 Tage in der Zukunft liegen.");
                    } else {
                        var latitude = locationSelect.getAttribute('data-lat')
                        var longitude = locationSelect.getAttribute('data-long')
                        await callToApi("https://api.open-meteo.com/v1/forecast?latitude=" + latitude + "&longitude=" + longitude + "&hourly=temperature_2m&start_date=" + startDate + "&end_date=" + endDate);
                    }
                } else if (historyChecker.checked) {
                    const minDate = new Date(1970, 0, 1);
                    const minTwoDaysAgo = new Date();
                    minTwoDaysAgo.setDate(minTwoDaysAgo.getDate() - 2);

                    if (new Date(startDate) < minDate || new Date(endDate) < minDate || new Date(startDate) > minTwoDaysAgo || new Date(endDate) > minTwoDaysAgo) {
                        alert("Das Datum darf nicht älter als 1970 sein und muss mindestens 2 Tage alt sein.");
                    } else {
                        var latitude = locationSelect.getAttribute('data-lat')
                        var longitude = locationSelect.getAttribute('data-long')
                        await callToApi("https://archive-api.open-meteo.com/v1/archive?latitude=" + latitude + "&longitude=" + longitude + "&start_date=" + startDate + "&end_date=" + endDate + "&hourly=temperature_2m");
                    }
                }
            } else {
                console.error("Invalid date format");
            }
        }

        chartTableSwitch.addEventListener('change', function () {
            const isChart = this.checked;

            if (isChart) {
                tableContainer.style.display = 'none';
                chartContainer.style.display = 'block';
            } else {
                tableContainer.style.display = 'block';
                chartContainer.style.display = 'none';
            }

            if (locationSelect.getAttribute('data-lat') && locationSelect.getAttribute('data-long')){
                fetchWeatherData();
            }
        });

        locationSelect.addEventListener('input', async function () {
            const selectedLocation = this.value;

            if (selectedLocation) {
                const apiUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${selectedLocation}`;

                const response = await fetch(apiUrl);
                console.info("HTTP-Status: Code " + response.status + "\nURL: " + apiUrl);

                if (response.ok) {
                    const data = await response.json();
                    locationList.innerHTML = '';

                    if (data.results) {
                        data.results.forEach((location => {
                            const locationItem = document.createElement('div');
                            locationItem.classList.add('location-item');
                            locationItem.innerHTML = `
                                    <span class="location-name">${location.name}</span>
                                    <span class="location-state">${location.admin1}</span>
                                    <span class="location-country">${location.country}</span>
                                `;
                            
                                let pattern = new RegExp(location.name, 'gi');
                                let result = pattern.test(locationSelect.value);
                                matched = result ? true : false;

                            if (matched) {
                                locationSelect.setAttribute('data-long', location.longitude)
                                locationSelect.setAttribute('data-lat', location.latitude)
                            } else {
                                locationSelect.removeAttribute('data-long');
                                locationSelect.removeAttribute('data-lat');
                            }

                            locationItem.addEventListener('click', () => {
                                locationSelect.value = location.name;
                                locationSelect.setAttribute('data-long', location.longitude)
                                locationSelect.setAttribute('data-lat', location.latitude)
                                locationList.innerHTML = '';
                                locationList.style.display = 'none';
                            });

                            locationList.appendChild(locationItem);
                        }))

                        locationList.style.display = 'block';
                    } else {
                        locationList.style.display = 'none';
                    }
                } else {
                    console.error('Fehler beim Abrufen der Daten');
                }
            }
        });

        dateInputs.forEach(input => {
            input.addEventListener('input', function () {
                const inputValue = this.value;
                if (!isValidDateFormat(inputValue)) {
                    this.classList.add('invalid');
                } else {
                    this.classList.remove('invalid');
                }
            });

            const submitButton = document.getElementById('submitButton');
            submitButton.addEventListener('click', fetchWeatherData);
        });
    });
</script>

<body>

    <div class="header">
        <div class="form-container">
            <label for="location">Ort:</label>
            <div class="location-input-container">
                <input type="text" id="location" class="location-input" placeholder="Ort eingeben">
                <div id="locationList" class="location-list" style="display: none;"></div>
            </div>

            <label for="startDate">Start Date:</label>
            <input type="text" id="startDate" class="date-input" placeholder="YYYY-MM-DD">

            <label for="endDate">End Date:</label>
            <input type="text" id="endDate" class="date-input" placeholder="YYYY-MM-DD">

            <label for="historyChecker">Historical Switch:</label>
            <div class="switch-container">
                <input type="checkbox" id="historyChecker" class="switch-input">
                <label for="historyChecker" class="switch-label"></label>
            </div>

            <label for="chartTableSwitch">Use Graph:</label>
            <div class="switch-container">
                <input type="checkbox" id="chartTableSwitch" class="switch-input">
                <label for="chartTableSwitch" class="switch-label"></label>
            </div>
        </div>

        <div class="submit-container">
            <input type="submit" value="Update" class="submit-button" id="submitButton">
        </div>
    </div>

    <div id="tableContainer">
        <table class="">
            <thead>
                <tr>
                    <th>
                        Datum
                    </th>
                    <th>
                        Wert
                    </th>
                </tr>
            </thead>
            <tbody id="tempTable">

            </tbody>
        </table>
    </div>

    <div id="chartContainer" class="chart-container">
        <canvas id="temperatureChart"></canvas>
    </div>
</body>

</html>
